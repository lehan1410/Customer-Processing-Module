<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chọn Món - Đơn hàng #{{ order_id }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Lora:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* --- Basic Reset and Global Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #F5F5F5;
            font-family: 'Inter', sans-serif;
            color: #333333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background: #ffff;
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        header h1 {
            font-family: 'Lora', sans-serif;
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.6em;
            transition: color 0.3s ease;
        }

        header h1:hover {
            color: #E57373;
        }

        main {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            overflow-y: auto;
        }

        .container {
            background: #FFFFFF;
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            width: 95%;
            max-width: 1100px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .container h1.page-title {
            font-family: 'Lora', serif;
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            text-align: center;
        }

        .container h2.section-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.4em;
            color: #333;
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .menu-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .menu-item {
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .menu-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }

        .menu-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .item-details {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: space-between;
        }

        .item-details h3 {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .item-price {
            font-size: 1em;
            color: #E57373;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .item-price.included {
            color: #555;
            font-weight: normal;
            font-style: italic;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .quantity-controls button {
            background-color: #eee;
            border: none;
            color: #333;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            line-height: 28px;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .quantity-controls button:hover:not(:disabled) {
            background-color: #ddd;
        }

        .quantity-controls button:active:not(:disabled) {
            background-color: #ccc;
        }

        .quantity-controls button:disabled {
            background-color: #f0f0f0;
            color: #aaa;
            cursor: not-allowed;
        }

        .quantity-controls .quantity {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0 15px;
            min-width: 20px;
            text-align: center;
        }

        .menu-item input[type="number"] {
            display: none;
        }

        .note-section {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
        }

        .note-section label {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .note-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #E0E0E0;
            border-radius: 5px;
            font-size: 1em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.3s ease;
        }

        .note-section textarea:focus {
            border-color: #E57373;
            outline: none;
            box-shadow: 0 0 5px rgba(229, 115, 115, 0.3);
        }

        .note-section textarea:disabled {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        #order-summary {
            background-color: #fff;
            padding: 15px 20px;
            border-top: 2px solid #E57373;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 900;
        }

        #cart-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #cart-info h4 {
            margin-bottom: 5px;
            font-size: 1.1em;
            font-weight: 500;
        }

        #current-selection-list {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 8px;
            max-height: 40px;
            overflow-y: auto;
            min-height: 1.2em;
        }

        #current-selection-list span {
            margin-right: 10px;
            display: inline-block;
        }

        #cart-toggle {
            cursor: pointer;
            color: #333;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
            margin-top: 10px;
            margin-bottom: 5px;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
        }

        #toggle-arrow {
            display: inline-block;
            transition: transform 0.3s ease;
            width: 1em;
            text-align: center;
        }

        #toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        #submitted-items-list {
            font-size: 0.9em;
            color: #666;
            list-style: none;
            padding-left: 15px;
            max-height: 60px;
            overflow-y: auto;
            display: none;
            margin-bottom: 8px;
        }

        #submitted-items-list li {
            margin-bottom: 3px;
        }

        #total-price-container {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-top: auto;
            padding-top: 5px;
        }

        #summary-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .summary-btn {
            padding: 10px 20px;
            color: #FFFFFF;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease, opacity 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .summary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .confirm-btn {
            background: #4CAF50;
        }

        .confirm-btn:hover:not(:disabled) {
            background: #45A049;
        }

        .confirm-btn:disabled {
            background: #9ccc9e;
        }

        .checkout-btn {
            background: #FF9800;
        }

        .checkout-btn:hover:not(:disabled) {
            background: #FB8C00;
        }

        .checkout-btn:disabled {
            background: #ffcc80;
        }

        footer {
            background: #1A1A1A;
            color: #B0B0B0;
            text-align: center;
            padding: 20px;
            border-top: 2px solid #E57373;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        footer a {
            color: #E57373;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: #FFFFFF;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FFFFFF;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            text-align: center;
            min-width: 300px;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .popup h2 {
            font-size: 1.8em;
            color: #34495e;
            margin-bottom: 20px;
        }

        .popup h2.error {
            color: #e74c3c;
        }

        .popup p {
            font-size: 1.1em;
            color: #555;
        }

        .popup .note-display {
            margin-top: 15px;
            font-size: 1em;
            color: #555;
            font-style: italic;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            text-align: left;
        }

        #paymentPopup {
            min-width: 350px;
            max-width: 700px;
            padding: 40px;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
        }

        #paymentContent.initial {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #paymentContent.initial p {
            font-size: 1.2em;
            color: #34495e;
        }

        #paymentContent.initial button {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: 600;
            background: #1abc9c;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        #paymentContent.initial button:hover {
            background: #16a085;
            transform: translateY(-2px);
        }

        #paymentContent.full .order-details {
            background: #f9fbfc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e0e7ff;
        }

        #paymentContent.full p {
            font-size: 1.1em;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #paymentContent.full p i {
            color: #1abc9c;
        }

        #paymentContent.full ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        #paymentContent.full li {
            padding: 10px 0;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            justify-content: space-between;
        }

        #paymentContent.full li:last-child {
            border-bottom: none;
        }

        #paymentContent.full .payment-methods label {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }

        #paymentContent.full .payment-methods select {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fff;
            color: #333;
        }

        #paymentContent.full .payment-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        #paymentContent.full .payment-btn {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 500;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        #paymentContent.full #confirmPaymentBtn {
            background: #1abc9c;
            color: #fff;
        }

        #paymentContent.full #confirmPaymentBtn:hover {
            background: #16a085;
            transform: translateY(-2px);
        }

        #paymentContent.full #cancelPaymentBtn {
            background: #e74c3c;
            color: #fff;
        }

        #paymentContent.full #cancelPaymentBtn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .menu-items-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .container {
                width: 100%;
                padding: 15px;
                border-radius: 0;
                border: none;
            }

            header h1 {
                font-size: 1.3em;
            }

            .container h1.page-title {
                font-size: 1.5em;
            }

            .container h2.section-title {
                font-size: 1.2em;
            }

            .menu-item img {
                height: 100px;
            }

            #order-summary {
                flex-direction: column;
                align-items: stretch;
                padding: 10px;
            }

            #cart-info {
                margin-bottom: 15px;
                text-align: center;
            }

            #cart-info h4,
            #current-selection-list,
            #cart-toggle {
                text-align: left;
            }

            #submitted-items-list {
                text-align: left;
            }

            #summary-buttons {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .summary-btn {
                width: 100%;
                padding: 12px;
                font-size: 1em;
            }

            #total-price-container {
                text-align: center;
                margin-top: 10px;
            }

            #paymentPopup {
                min-width: 90%;
                padding: 20px;
            }

            #paymentContent.full .payment-buttons {
                flex-direction: column;
                gap: 10px;
            }

            #paymentContent.full .payment-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Chọn Món - Đơn hàng {{ order_id }}</h1>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title">Menu - Bàn {{ order.table_id }} - Gói {{ order.package_id }}</h1>

            <form id="menuForm" method="post" style="width: 100%;">
                <input type="hidden" name="order_id" value="{{ order_id }}">
                <input type="hidden" id="orderIdInput" value="{{ order_id }}">
                {% if type == '1' %}
                <h2 class="section-title">Món trong A-la-carte</h2>
                <div class="menu-items-grid">
                    {% for item in alacarte_items %}
                    <div class="menu-item" data-id="{{ item.food_id }}" data-price="{{ item.price }}"
                        data-is-extra-cost="true">
                        <img src="https://lavenderstudio.com.vn/wp-content/uploads/2017/03/chup-san-pham.jpg"
                            onerror="this.onerror=null; this.src='https://placehold.co/200x140/cccccc/ffffff?text=Image+Not+Found';"
                            alt="{{ item.food_name }}">
                        <div class="item-details">
                            <div>
                                <h3>{{ item.food_name }}</h3>
                                <p class="item-price" data-raw-price="{{ item.price }}">{{ item.price }} VNĐ</p>
                            </div>
                            <input type="number" name="food_items[{{ item.food_id }}]" value="0" min="0"
                                data-price="{{ item.price }}">
                            <div class="quantity-controls">
                                <button type="button" class="decrease"
                                    aria-label="Giảm số lượng {{ item.food_name }}">-</button>
                                <span class="quantity">0</span>
                                <button type="button" class="increase"
                                    aria-label="Tăng số lượng {{ item.food_name }}">+</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if type == '2' %}
                <h2 class="section-title">Món trong Buffet</h2>
                <div class="menu-items-grid">
                    {% for item in buffet_items %}
                    <div class="menu-item" data-id="{{ item.food_id }}" data-price="0" data-is-extra-cost="false">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT_iTFFdCKc0USnbq3j6wVau2YosOs0If3noijp4pi88JJNcfXOn9rknMtFYCwl3jIM4f8&usqp=CAU"
                            onerror="this.onerror=null; this.src='https://placehold.co/200x140/cccccc/ffffff?text=Image+Not+Found';"
                            alt="{{ item.food_name }}">
                        <div class="item-details">
                            <div>
                                <h3>{{ item.food_name }}</h3>
                                <p class="item-price included">Đã bao gồm</p>
                            </div>
                            <input type="number" name="food_items[{{ item.food_id }}]" value="0" min="0" data-price="0">
                            <div class="quantity-controls">
                                <button type="button" class="decrease"
                                    aria-label="Giảm số lượng {{ item.food_name }}">-</button>
                                <span class="quantity">0</span>
                                <button type="button" class="increase"
                                    aria-label="Tăng số lượng {{ item.food_name }}">+</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <h2 class="section-title">Các món khác (Tính phí riêng)</h2>
                <div class="menu-items-grid">
                    {% for item in other_items %}
                    <div class="menu-item" data-id="{{ item.food_id }}" data-price="{{ item.price }}"
                        data-is-extra-cost="true">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQp4jKpywdq40kBOAFWDdN7BuA9Wdk7tHxH8A&s"
                            onerror="this.onerror=null; this.src='https://placehold.co/200x140/cccccc/ffffff?text=Image+Not+Found';"
                            alt="{{ item.food_name }}">
                        <div class="item-details">
                            <div>
                                <h3>{{ item.food_name }}</h3>
                                <p class="item-price" data-raw-price="{{ item.price }}">{{ item.price }} VNĐ</p>
                            </div>
                            <input type="number" name="food_items[{{ item.food_id }}]" value="0" min="0"
                                data-price="{{ item.price }}">
                            <div class="quantity-controls">
                                <button type="button" class="decrease"
                                    aria-label="Giảm số lượng {{ item.food_name }}">-</button>
                                <span class="quantity">0</span>
                                <button type="button" class="increase"
                                    aria-label="Tăng số lượng {{ item.food_name }}">+</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if type == '3' %}
                <h2 class="section-title">Món trong Combo</h2>
                <div class="menu-items-grid">
                    {% for item in combo_items %}
                    <div class="menu-item" data-id="{{ item.food_id }}" data-price="0" data-is-extra-cost="false">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3uxgSUdnmrtHFNUuDiUrx6UnHpbh7RmeJjA&s"
                            onerror="this.onerror=null; this.src='https://placehold.co/200x140/cccccc/ffffff?text=Image+Not+Found';"
                            alt="{{ item.food_name }}">
                        <div class="item-details">
                            <div>
                                <h3>{{ item.food_name }}</h3>
                                <p class="item-price included">Đã bao gồm (x1)</p>
                            </div>
                            <input type="number" name="food_items[{{ item.food_id }}]" value="1" min="1" max="1"
                                data-price="0" style="display:none;">
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <h2 class="section-title">Các món khác (Tính phí riêng)</h2>
                <div class="menu-items-grid">
                    {% for item in other_items %}
                    <div class="menu-item" data-id="{{ item.food_id }}" data-price="{{ item.price }}"
                        data-is-extra-cost="true">
                        <img src="https://lavenderstudio.com.vn/wp-content/uploads/2017/03/chup-san-pham.jpg"
                            onerror="this.onerror=null; this.src='https://placehold.co/200x140/cccccc/ffffff?text=Image+Not+Found';"
                            alt="{{ item.food_name }}">
                        <div class="item-details">
                            <div>
                                <h3>{{ item.food_name }}</h3>
                                <p class="item-price" data-raw-price="{{ item.price }}">{{ item.price }} VNĐ</p>
                            </div>
                            <input type="number" name="food_items[{{ item.food_id }}]" value="0" min="0"
                                data-price="{{ item.price }}">
                            <div class="quantity-controls">
                                <button type="button" class="decrease"
                                    aria-label="Giảm số lượng {{ item.food_name }}">-</button>
                                <span class="quantity">0</span>
                                <button type="button" class="increase"
                                    aria-label="Tăng số lượng {{ item.food_name }}">+</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if not alacarte_items and not buffet_items and not combo_items and not other_items %}
                <p style="text-align: center; margin-top: 30px; color: #777;">Không có món ăn nào phù hợp với gói đã
                    chọn.</p>
                {% endif %}

                <div class="note-section">
                    <label for="order-note">Ghi chú cho bếp:</label>
                    <textarea id="order-note" placeholder="Ví dụ: Không cay, thêm rau..."></textarea>
                </div>

                <input type="hidden" id="hiddenTotalAmount" name="total_amount" value="{{ package_price }}">
            </form>
        </div>
    </main>

    <section id="order-summary">
        <div id="cart-info">
            <h4>Giỏ hàng (<span id="total-items">0</span> món thêm)</h4>
            <div id="current-selection-list">
                {% if type == '1' %}Chưa chọn món nào.{% else %}Chưa gọi món thêm.{% endif %}
            </div>
            <div id="cart-items-list-wrapper">
                <div id="cart-toggle">
                    <span id="toggle-arrow">▶</span> <strong>Lịch sử món đã gọi:</strong>
                </div>
                <ul id="submitted-items-list">
                    <li id="no-history-placeholder">Chưa có món nào được gửi đi.</li>
                </ul>
            </div>
            <div id="total-price-container">
                Tổng cộng: <span id="total-price">{{ package_price }}</span> VNĐ
            </div>
        </div>

        <div id="summary-buttons">
            <button type="button" class="summary-btn confirm-btn" id="submitFormButton">Xác Nhận Đơn</button>
            <button type="button" class="summary-btn checkout-btn" id="checkoutButton" disabled>Thanh toán</button>
        </div>
    </section>

    <footer>
        <p>© 2025 Your Restaurant Name | Developed by <a href="#">You</a></p>
    </footer>

    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="popup" id="confirmationPopup">
        <h2>Đơn hàng đã được gửi!</h2>
        <p>Đơn hàng của bạn đã được gửi đến bếp thành công.</p>
        <div class="note-display" id="popup-note"></div>
    </div>
    <div class="popup" id="paymentPopup">
        <h2><i class="fas fa-credit-card"></i> Thanh Toán - Đơn hàng #{{ order_id }}</h2>
        <div id="paymentContent" class="payment-content">
            <!-- Nội dung sẽ được điền bằng JavaScript -->
        </div>
    </div>

    <script>
        // --- Helper Function ---
        function formatCurrency(amount) {
            const numAmount = Number(amount);
            if (isNaN(numAmount)) {
                console.warn("formatCurrency received non-numeric value:", amount);
                return amount;
            }
            return numAmount.toLocaleString('vi-VN');
        }

        // --- Main Script ---
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io('http://localhost:5000');
            socket.on('connect', () => console.log('Connected to WebSocket'));
            socket.on('disconnect', () => console.log('Disconnected from WebSocket'));
            socket.on('connect_error', (err) => console.error('WebSocket connection error:', err));

            // DOM Elements
            const menuItemsGrid = document.querySelectorAll('.menu-items-grid');
            const totalAmountElement = document.getElementById('total-price');
            const totalItemsElement = document.getElementById('total-items');
            const currentSelectionList = document.getElementById('current-selection-list');
            const hiddenTotalAmountInput = document.getElementById('hiddenTotalAmount');
            const menuForm = document.getElementById('menuForm');
            const submitFormButton = document.getElementById('submitFormButton');
            const checkoutButton = document.getElementById('checkoutButton');
            const orderNoteTextarea = document.getElementById('order-note');
            const popupOverlay = document.getElementById('popupOverlay');
            const confirmationPopup = document.getElementById('confirmationPopup');
            const paymentPopup = document.getElementById('paymentPopup');
            const paymentContent = document.getElementById('paymentContent');
            const popupNote = document.getElementById('popup-note');
            const toggleArrow = document.getElementById('toggle-arrow');
            const submittedItemsList = document.getElementById('submitted-items-list');
            const cartToggle = document.getElementById('cart-toggle');
            const orderIdInput = document.getElementById('orderIdInput');
            let noHistoryPlaceholder = document.getElementById('no-history-placeholder');
            let orderHasBeenSubmitted = false;

            // Initial State
            const packagePrice = parseFloat("{{ package_price }}") || 0;
            const orderType = parseInt("{{ type }}", 10) || 0;
            const orderId = orderIdInput ? orderIdInput.value : null;
            let orderNote = '';

            // Toggle Submitted Items History
            cartToggle.addEventListener('click', () => {
                const isHidden = submittedItemsList.style.display === 'none';
                submittedItemsList.style.display = isHidden ? 'block' : 'none';
                toggleArrow.classList.toggle('expanded', isHidden);
                toggleArrow.textContent = isHidden ? '▼' : '▶';
            });

            // Update Summary for Current Selection
            function updateTotal() {
                let currentTotal = packagePrice;
                let extraItemCount = 0;
                let currentSelectionHtml = '';

                document.querySelectorAll('.menu-item').forEach(itemCard => {
                    const quantityInput = itemCard.querySelector('input[type="number"]');
                    const quantitySpan = itemCard.querySelector('.quantity');
                    const isExtraCost = itemCard.dataset.isExtraCost === 'true';
                    if (!quantityInput) return;
                    const quantity = parseInt(quantityInput.value, 10) || 0;
                    const price = parseFloat(quantityInput.dataset.price) || 0;
                    if (quantitySpan) quantitySpan.textContent = quantity;
                    if (isExtraCost && quantity > 0) {
                        currentTotal += quantity * price;
                        extraItemCount += quantity;
                        const itemName = itemCard.querySelector('h3')?.textContent || 'Món';
                        currentSelectionHtml += `<span>${itemName} (x${quantity})</span> `;
                    }
                });

                totalAmountElement.textContent = formatCurrency(currentTotal);
                totalItemsElement.textContent = extraItemCount;
                hiddenTotalAmountInput.value = currentTotal;

                if (extraItemCount === 0) {
                    if (orderType === 1) {
                        currentSelectionList.textContent = 'Chưa chọn món nào.';
                    } else {
                        currentSelectionList.textContent = 'Chưa gọi món thêm.';
                    }
                } else {
                    currentSelectionList.innerHTML = currentSelectionHtml.trim();
                }
            }

            // Format Initial Prices
            function formatInitialPrices() {
                document.querySelectorAll('.item-price:not(.included)').forEach(priceEl => {
                    const rawPrice = priceEl.dataset.rawPrice || priceEl.textContent.replace(/[^0-9.]/g, '');
                    if (rawPrice) priceEl.textContent = `${formatCurrency(rawPrice)} VNĐ`;
                });
                const initialTotalPriceSpan = document.getElementById('total-price');
                const rawPackagePrice = parseFloat("{{ package_price }}") || 0;
                initialTotalPriceSpan.textContent = formatCurrency(rawPackagePrice);
            }

            // Event Listeners for Quantity Buttons
            menuItemsGrid.forEach(grid => {
                grid.addEventListener('click', (event) => {
                    const target = event.target;
                    const itemCard = target.closest('.menu-item');
                    if (!itemCard || !target.closest('.quantity-controls')) return;
                    const quantityInput = itemCard.querySelector('input[type="number"]');
                    if (!quantityInput) return;
                    let currentQuantity = parseInt(quantityInput.value, 10) || 0;
                    if (target.classList.contains('increase')) {
                        quantityInput.value = currentQuantity + 1;
                    } else if (target.classList.contains('decrease') && currentQuantity > 0) {
                        quantityInput.value = currentQuantity - 1;
                    }
                    updateTotal();
                });
            });

            // Update Note on Input
            orderNoteTextarea.addEventListener('input', (e) => {
                orderNote = e.target.value.trim();
            });

            // Show/Hide Popup Utility
            function showPopup(popupElement) {
                popupOverlay.style.display = 'block';
                popupElement.style.display = 'block';
            }

            function hidePopup(popupElement) {
                popupOverlay.style.display = 'none';
                popupElement.style.display = 'none';
            }

            // Form Submission Trigger
            submitFormButton.addEventListener('click', () => {
                menuForm.requestSubmit();
            });

            // Form Submission Handling (Gửi đến bếp)
            menuForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                let currentSelectionHasItems = false;
                let currentSelectionHasExtraCostItems = false;

                document.querySelectorAll('.menu-item input[type="number"]').forEach(input => {
                    const quantity = parseInt(input.value, 10) || 0;
                    if (quantity > 0) {
                        currentSelectionHasItems = true;
                        const itemCard = input.closest('.menu-item');
                        if (itemCard && itemCard.dataset.isExtraCost === 'true') {
                            currentSelectionHasExtraCostItems = true;
                        }
                    }
                    const inputName = input.getAttribute('name');
                    if (inputName) formData.set(inputName, input.value);
                });

                if (orderType === 1 && !currentSelectionHasItems) {
                    alert('Vui lòng chọn ít nhất một món với số lượng lớn hơn 0 trước khi gửi!');
                    return;
                }


                formData.set('total_amount', hiddenTotalAmountInput.value);

                const submittedOrderData = {
                    order_id: orderId,
                    table_id: "{{ order.table_id }}",
                    package_id: "{{ order.package_id }}",
                    food_items: {},
                    total_amount: hiddenTotalAmountInput.value,
                    note: orderNote
                };

                let itemsInThisSubmissionCount = 0;
                formData.forEach((value, key) => {
                    if (key.startsWith('food_items[')) {
                        const quantity = parseInt(value, 10);
                        if (quantity > 0) {
                            submittedOrderData.food_items[key] = value;
                            itemsInThisSubmissionCount++;
                        }
                    }
                });
                if (orderType === 3) {
                    document.querySelectorAll('.menu-item[data-price="0"][data-is-extra-cost="false"]').forEach(comboItem => {
                        const foodId = comboItem.dataset.id;
                        const inputName = `food_items[${foodId}]`;
                        if (!submittedOrderData.food_items[inputName]) {
                            submittedOrderData.food_items[inputName] = '1';
                            if (itemsInThisSubmissionCount === 0) itemsInThisSubmissionCount++;
                        }
                    });
                }

                if (itemsInThisSubmissionCount === 0 && !orderNote.trim()) {
                    alert("Không có món nào được chọn hoặc ghi chú được thêm.");
                    return;
                }

                console.log("Submitting order data to kitchen:", submittedOrderData);
                submitFormButton.disabled = true;

                fetch('/order/confirm_order', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        submitFormButton.disabled = false;
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(`Lỗi ${response.status}: ${errData.message || response.statusText}`);
                            }).catch(() => {
                                throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Server response:", data);
                        if (data.message === "Order confirmed and sent to kitchen") {
                            orderHasBeenSubmitted = true;
                            checkoutButton.disabled = false;
                            socket.emit('new_order', submittedOrderData);

                            const confirmationTitle = "Đơn hàng đã được gửi!";
                            const confirmationMessage = "Đơn hàng của bạn đã được gửi đến bếp thành công.";
                            popupNote.textContent = submittedOrderData.note ? `Ghi chú: ${submittedOrderData.note}` : '';
                            popupNote.style.display = submittedOrderData.note ? 'block' : 'none';
                            showPopup(confirmationPopup);
                            setTimeout(() => hidePopup(confirmationPopup), 3000);

                            let historyItemsAdded = false;
                            for (const key in submittedOrderData.food_items) {
                                const match = key.match(/\[(\d+)\]/);
                                if (!match) continue;
                                const foodId = match[1];
                                const quantity = parseInt(submittedOrderData.food_items[key], 10);
                                if (quantity > 0) {
                                    const itemCard = document.querySelector(`.menu-item[data-id='${foodId}']`);
                                    if (itemCard) {
                                        const isFixedComboItem = orderType === 3 && itemCard.dataset.isExtraCost === 'false';
                                        if (!isFixedComboItem) {
                                            if (noHistoryPlaceholder) {
                                                noHistoryPlaceholder.remove();
                                                noHistoryPlaceholder = null;
                                            }
                                            const name = itemCard.querySelector('h3')?.textContent || 'Món';
                                            const li = document.createElement('li');
                                            li.textContent = `${name} (x${quantity})`;
                                            submittedItemsList.appendChild(li);
                                            historyItemsAdded = true;
                                        }
                                    }
                                }
                            }
                            if (submittedOrderData.note) {
                                if (noHistoryPlaceholder) {
                                    noHistoryPlaceholder.remove();
                                    noHistoryPlaceholder = null;
                                }
                                const li = document.createElement('li');
                                li.style.fontStyle = 'italic';
                                li.textContent = `Ghi chú: ${submittedOrderData.note}`;
                                submittedItemsList.appendChild(li);
                                historyItemsAdded = true;
                            }

                            document.querySelectorAll('.menu-item').forEach(itemCard => {
                                const quantityInput = itemCard.querySelector('input[type="number"]');
                                const quantitySpan = itemCard.querySelector('.quantity');
                                if (quantityInput && quantityInput.getAttribute('max') !== '1') {
                                    quantityInput.value = 0;
                                    if (quantitySpan) quantitySpan.textContent = '0';
                                }
                            });
                            orderNoteTextarea.value = '';
                            orderNote = '';
                            updateTotal();
                        } else {
                            alert('Lỗi từ server: ' + (data.message || 'Không xác định'));
                        }
                    })
                    .catch(error => {
                        submitFormButton.disabled = false;
                        console.error('Fetch Error:', error);
                        alert('Không thể gửi đơn hàng: ' + error.message);
                    });
            });

            // Checkout Button Handling (Hiển thị popup xác nhận thanh toán)
            checkoutButton.addEventListener('click', () => {
                if (!orderHasBeenSubmitted) {
                    alert("Vui lòng xác nhận đơn hàng trước khi thanh toán.");
                    return;
                }
                if (!orderId) {
                    alert("Lỗi: Không tìm thấy mã đơn hàng để thanh toán.");
                    return;
                }

                checkoutButton.disabled = true;

                fetch(`/order/payment_data/${orderId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                try {
                                    const errData = JSON.parse(text);
                                    throw new Error(errData.message || `Lỗi ${response.status}`);
                                } catch (e) {
                                    throw new Error(`Lỗi ${response.status}: ${text}`);
                                }
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        const paymentRequestData = {
                            order_id: orderId,
                            table_id: data.table_id,
                            total_amount: data.total_amount,
                            package_name: data.package_name,
                            package_type: data.package_type,
                            order_items: data.order_items,
                            order_note: data.order_note || ''
                        };

                        // Hiển thị popup xác nhận thanh toán (không có dropdown phương thức thanh toán)
                        paymentContent.classList.remove('initial');
                        paymentContent.classList.add('full');
                        paymentContent.innerHTML = `
            <div class="order-details">
                <p><i class="fas fa-table"></i> <strong>Bàn:</strong> ${paymentRequestData.table_id}</p>
                <p><i class="fas fa-box"></i> <strong>Gói:</strong> ${paymentRequestData.package_name}</p>
                <p><i class="fas fa-money-bill-wave"></i> <strong>Tổng tiền:</strong> ${formatCurrency(paymentRequestData.total_amount)} VNĐ</p>
                <ul>
                    ${paymentRequestData.order_items.map(item => `
                        <li>
                            <span>${item.food_name} (x${item.quantity})</span>
                            <span>${item.is_extra_cost ? formatCurrency(item.price * item.quantity) + ' VNĐ' : 'Đã bao gồm'}</span>
                        </li>
                    `).join('')}
                </ul>
                ${paymentRequestData.order_note ? `<p><i class="fas fa-sticky-note"></i> <strong>Ghi chú:</strong> ${paymentRequestData.order_note}</p>` : ''}
            </div>
            <div class="payment-buttons">
                <button class="payment-btn" id="confirmPaymentBtn"><i class="fas fa-check"></i> Xác Nhận</button>
                <button class="payment-btn" id="cancelPaymentBtn"><i class="fas fa-times"></i> Hủy</button>
            </div>
        `;
                        showPopup(paymentPopup);

                        // Xử lý nút Xác Nhận
                        document.getElementById('confirmPaymentBtn').addEventListener('click', () => {
                            // Gửi yêu cầu tạo hóa đơn đến payment_service
                            fetch('/payment/create_invoice', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    order_id: paymentRequestData.order_id,
                                    table_id: paymentRequestData.table_id,
                                    total_amount: paymentRequestData.total_amount
                                }),
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.json().then(errData => {
                                            throw new Error(errData.message || `Lỗi ${response.status}`);
                                        });
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    const invoiceId = data.invoice_id;
                                    paymentRequestData.invoice_id = invoiceId;

                                    // Gửi yêu cầu thanh toán qua WebSocket
                                    console.log("Sending payment request to waiter:", paymentRequestData);
                                    socket.emit('payment_request', paymentRequestData);

                                    hidePopup(paymentPopup);
                                })
                                .catch(error => {
                                    console.error('Error creating invoice:', error);
                                    alert('Lỗi khi tạo hóa đơn: ' + error.message);
                                    checkoutButton.disabled = false;
                                });
                        });

                        // Xử lý nút Hủy
                        document.getElementById('cancelPaymentBtn').addEventListener('click', () => {
                            hidePopup(paymentPopup);
                            checkoutButton.disabled = false;
                        });
                    })
                    .catch(error => {
                        checkoutButton.disabled = false;
                        paymentContent.innerHTML = `<p>${error.message}</p>`;
                        paymentPopup.querySelector('h2').textContent = 'Lỗi Gửi Yêu Cầu';
                        paymentPopup.querySelector('h2').classList.add('error');
                        showPopup(paymentPopup);
                        setTimeout(() => hidePopup(paymentPopup), 5000);
                    });
            });
            // Initial Page Setup
            formatInitialPrices();
            updateTotal();



        });
    </script>
</body>

</html>